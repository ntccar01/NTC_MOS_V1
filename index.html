<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ‹ç«‹è‡ºæ±å°ˆç§‘å­¸æ ¡å“¡ç”Ÿç¤¾ä¾¿ç•¶ä»£è¨‚ç³»çµ±</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f7f6; margin: 0; padding: 15px; line-height: 1.6; }
        .container { max-width: 600px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        #login-mask { position: fixed; top:0; left:0; width:100%; height:100%; background:#1e3a8a; display:flex; justify-content:center; align-items:center; z-index:9999; }
        .login-box { background:white; padding:40px; border-radius:15px; text-align:center; width: 90%; max-width: 400px; }
        
        .notice-bar { background: #d1e7dd; color: #0f5132; padding: 12px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #198754; font-size: 0.9em; }
        
        .form-group { margin-bottom: 20px; }
        label { font-weight: bold; display: block; margin-bottom: 8px; color: #1e3a8a; }
        input[type="text"], input[type="tel"], input[type="password"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        
        /* èœå–®å¡ç‰‡æ¨£å¼ */
        .menu-item { background: #fff; border: 2px solid #e2e8f0; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        .dish-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }
        .dish-image { width: 70px; height: 70px; object-fit: cover; border-radius: 8px; background: #eee; }
        .dish-name { font-weight: bold; font-size: 1.2em; color: #1e293b; }

        /* è¦æ ¼é¸æ“‡å€ */
        .option-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #f1f5f9; }
        .option-label { font-size: 0.95em; color: #475569; flex-grow: 1; }
        .option-price { color: #ef4444; font-weight: bold; margin: 0 10px; min-width: 50px; text-align: right; }
        
        /* æ•¸é‡æ§åˆ¶å™¨ */
        .qty-control { display: flex; align-items: center; gap: 5px; }
        .btn-qty { width: 30px; height: 30px; border: 1px solid #cbd5e1; background: #fff; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-qty:active { background: #f1f5f9; }
        .qty-input { width: 35px; text-align: center; border: none; font-size: 1.1em; font-weight: bold; background: none; }

        /* å‚™è¨»è¼¸å…¥æ¡† */
        .option-note { width: 100%; margin-top: 5px; padding: 8px; border: 1px solid #e2e8f0; border-radius: 5px; font-size: 0.85em; display: none; }
        .option-note.active { display: block; }

        .btn-submit { background: #1e3a8a; color: white; border: none; padding: 16px; width: 100%; border-radius: 8px; cursor: pointer; font-size: 1.1em; font-weight: bold; margin-top: 15px; }
        .btn-submit:disabled { background: #94a3b8; }

        #floating-total {
            position: fixed; bottom: 30px; right: 20px; background: #ef4444; color: white;
            padding: 12px 25px; border-radius: 50px; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
            font-weight: bold; z-index: 999; display: none;
        }

        /* ----- æ”¶æ“šåœ–ç‰‡æ¨£å¼ ----- */
        #receipt-container {
            position: fixed; left: -9999px; top: 0;
            width: 400px; background: white; padding: 20px;
            border: 2px solid #1e3a8a; border-radius: 0;
            font-family: "Microsoft JhengHei", sans-serif;
            color: #000;
        }
        .receipt-title { text-align: center; font-size: 1.5em; font-weight: bold; color: #1e3a8a; margin-bottom: 10px; border-bottom: 2px solid #1e3a8a; padding-bottom: 10px; }
        .receipt-info { margin-bottom: 15px; font-size: 1em; line-height: 1.4; }
        .receipt-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 0.9em; }
        .receipt-table th { background: #f1f5f9; text-align: left; padding: 5px; border-bottom: 1px solid #000; }
        .receipt-table td { padding: 5px; border-bottom: 1px dashed #ccc; vertical-align: top; }
        .receipt-total { text-align: right; font-size: 1.2em; font-weight: bold; color: #ef4444; margin-top: 10px; border-top: 2px solid #000; padding-top: 10px; }

        /* ----- æ–°å¢ï¼šæˆªæ­¢æ™‚çš„é–å®šæ¨£å¼ ----- */
        .disabled-ui {
            opacity: 0.5;                /* è®“ç•«é¢è®Šæ·¡/è®Šç° */
            filter: grayscale(80%);      /* é»‘ç™½æ¿¾é¡æ•ˆæœ */
            pointer-events: none;        /* ç¦æ­¢æ»‘é¼ é»æ“Šä»»ä½•æŒ‰éˆ• */
            user-select: none;           /* ç¦æ­¢é¸å–æ–‡å­— */
        }

        /* ----- æ–°å¢ï¼šæˆªæ­¢æé†’å°è¦–çª— ----- */
        #late-alert-box {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 3px solid #dc3545;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 0 25px rgba(0,0,0,0.5);
            text-align: center;
            z-index: 10000;
            width: 80%;
            max-width: 300px;
            display: none; /* é è¨­éš±è— */
        }
        #late-alert-box h3 { margin: 0 0 10px 0; color: #dc3545; font-size: 1.3em; }
        #late-alert-box p { margin: 0; font-weight: bold; color: #333; }
    </style>
</head>
<body>

<div id="login-mask">
    <div class="login-box">
        <h2 style="color:#1e3a8a;">ğŸ± å“¡ç”Ÿç¤¾è¨‚é¤é©—è­‰</h2>
        <input type="password" id="access-password" placeholder="è«‹è¼¸å…¥ä»£ç¢¼">
        <button onclick="checkAccess()" style="margin-top:20px; padding:12px 0; background:#1e3a8a; color:white; border:none; border-radius:8px; width:100%; font-weight:bold; cursor:pointer;">é€²å…¥ç³»çµ±</button>
    </div>
</div>

<div id="late-alert-box">
    <h3>â›” æˆªæ­¢æé†’</h3>
    <p>ä»Šæ—¥è¨‚è³¼æ™‚é–“å·²æˆªæ­¢<br>è«‹æ´½å“¡ç”Ÿç¤¾ç¾å ´</p>
</div>

<div class="container" id="main-content" style="display:none;">
    <div id="order-area">
        <h2 style="color:#1e3a8a; text-align:center;">ä»Šæ—¥ä¾¿ç•¶ä»£è¨‚</h2>
        <div class="notice-bar">â° æé†’ï¼šæ¯æ—¥ 09:30 æˆªæ­¢æ”¶å–®ï¼Œç³»çµ±è‡ªå‹•é—œé–‰ï¼Œè‹¥æœ‰å•é¡Œè«‹è¦ªæ´½å“¡ç”Ÿç¤¾ç¾å ´äººå“¡è©¢å•ã€‚</div>

        <form id="orderForm">
            <div class="form-group"><label>ç­ç´š / è™•å®¤</label><input type="text" id="class" required></div>
            <div class="form-group"><label>è² è²¬äººå§“å</label><input type="text" id="name" required></div>
            
            <div class="form-group">
                <label>è¨‚è³¼äººè¯çµ¡é›»è©±</label>
                <input type="tel" id="phone" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ (09xxxxxxxx)" maxlength="10" required>
            </div>

            <div id="dynamic-menu">ğŸ” è¼‰å…¥èœå–®ä¸­...</div>
            <button type="submit" id="submit-btn" class="btn-submit">ç¢ºèªé€å‡ºè¨‚å–®</button>
        </form>
    </div>

    <div id="floating-total">ğŸ›’ ç¸½è¨ˆï¼š$ <span id="display-price">0</span></div>
</div>

<div id="receipt-container">
    <div class="receipt-title">å“¡ç”Ÿç¤¾è¨‚è³¼æ˜ç´°</div>
    <div class="receipt-info" id="receipt-info"></div>
    <table class="receipt-table">
        <thead>
            <tr>
                <th width="65%">å“é … (å‚™è¨»)</th>
                <th width="15%">é‡</th>
                <th width="20%">é‡‘é¡</th>
            </tr>
        </thead>
        <tbody id="receipt-items"></tbody>
    </table>
    <div class="receipt-total" id="receipt-total"></div>
    <div style="text-align:center; margin-top:10px; font-size:0.8em; color:#666;">* è«‹ä¿ç•™æ­¤åœ–ç‰‡ä»¥ä¾›æ ¸å° *</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDhI4QdbwUCx7ch-Js4XFIpQmaH03do7bo",
        authDomain: "ntc-lunch-system-2025v1.firebaseapp.com",
        projectId: "ntc-lunch-system-2025v1",
        storageBucket: "ntc-lunch-system-2025v1.firebasestorage.app",
        messagingSenderId: "235133418606",
        appId: "1:235133418606:web:42ed342fa44dcf17c67a7f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const VARIATIONS = [
        { id: 'normal', name: 'æ­£å¸¸ (ä¸åŠ åƒ¹)', extra: 0 },
        { id: 'rice', name: 'åŠ é£¯+15å…ƒ', extra: 15 },
        { id: 'dish1', name: 'åŠ 1èœ+10å…ƒ', extra: 10 },
        { id: 'dish2', name: 'åŠ 2èœ+20å…ƒ', extra: 20 }
    ];

    // âœ… æ›´æ–°å¾Œçš„ç™»å…¥é‚è¼¯
    window.checkAccess = function() {
        const input = document.getElementById('access-password').value.trim();
        
        // è¨­å®šç¾åœ¨æ™‚é–“èˆ‡æˆªæ­¢æ™‚é–“
        const now = new Date();
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        const limitHour = 9;
        const limitMinute = 30;

        // åˆ¤æ–·æ˜¯å¦é²äº†
        const isLate = (currentHour > limitHour) || (currentHour === limitHour && currentMinute >= limitMinute);

        // --- 1. é–‹ç™¼è€…æ¨¡å¼ (æ°¸é ä¸é–) ---
        if (input === "test999") {
            alert(`ğŸ”§ é–‹ç™¼è€…æ¨¡å¼\næ™‚é–“ï¼š${currentHour}:${currentMinute}\nç‹€æ…‹ï¼š${isLate ? "å·²æˆªæ­¢(ç‰¹æ¬Šé€²å…¥)" : "é–‹æ”¾ä¸­"}`);
            grantAccess(); // æ­£å¸¸é€²å…¥
            return;
        }

        // --- 2. ä¸€èˆ¬ä½¿ç”¨è€…æ¨¡å¼ ---
        if (input === "ntc1234") {
            if (isLate) {
                // è‹¥é²äº†ï¼šé›–ç„¶é€²å…¥ï¼Œä½†é–ä½ä»‹é¢
                grantAccess(); 
                lockInterface(); // åŸ·è¡Œé–å®šç‰¹æ•ˆ
            } else {
                // è‹¥æ²’é²ï¼šæ­£å¸¸é€²å…¥
                grantAccess();
            }
            return;
        }

        alert("âŒ ä»£ç¢¼éŒ¯èª¤");
    };

    // é¡¯ç¤ºä¸»ç•«é¢ä¸¦è¼‰å…¥èœå–®
    function grantAccess() {
        document.getElementById('login-mask').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        document.getElementById('floating-total').style.display = 'flex';
        loadMenu();
    }

    // ğŸ”’ é–å®šä»‹é¢çš„ç‰¹æ•ˆå‡½å¼
    function lockInterface() {
        // 1. é¡¯ç¤ºã€Œæˆªæ­¢æé†’ã€å°è¦–çª—
        document.getElementById('late-alert-box').style.display = 'block';
        
        // 2. å°‡è¡¨å–®å€åŸŸåŠ å…¥ã€Œç°è‰²+ç„¡æ³•é»æ“Šã€çš„æ¨£å¼
        document.getElementById('orderForm').classList.add('disabled-ui');
        document.getElementById('floating-total').classList.add('disabled-ui');
        
        // 3. éš±è—é€å‡ºæŒ‰éˆ• (é›™é‡ä¿éšª)
        document.getElementById('submit-btn').style.display = 'none';
    }

    window.changeQty = function(btn, delta) {
        const input = btn.parentElement.querySelector('.qty-input');
        let val = parseInt(input.value) + delta;
        if (val < 0) val = 0;
        input.value = val;
        
        const note = btn.closest('.option-row').nextElementSibling;
        if (val > 0) note.classList.add('active');
        else note.classList.remove('active');
        
        updateTotal();
    };

    function updateTotal() {
        let total = 0;
        document.querySelectorAll('.qty-input').forEach(input => {
            const qty = parseInt(input.value);
            const base = parseInt(input.dataset.basePrice);
            const extra = parseInt(input.dataset.extra);
            total += qty * (base + extra);
        });
        document.getElementById('display-price').innerText = total;
    }

    async function loadMenu() {
        const menuDiv = document.getElementById('dynamic-menu');
        const querySnapshot = await getDocs(collection(db, "menu"));
        let menuHtml = "";
        
        querySnapshot.forEach((doc) => {
            const dish = doc.data();
            const imgSrc = dish.img || 'https://placehold.co/200x200?text=ç„¡åœ–ç‰‡';
            
            let varHtml = VARIATIONS.map(v => `
                <div class="option-item">
                    <div class="option-row">
                        <span class="option-label">${v.name}</span>
                        <span class="option-price">$${dish.price + v.extra}</span>
                        <div class="qty-control">
                            <button type="button" class="btn-qty" onclick="changeQty(this, -1)">-</button>
                            <input type="text" class="qty-input" value="0" readonly 
                                   data-dish-name="${dish.name}" 
                                   data-variation="${v.name}" 
                                   data-base-price="${dish.price}" 
                                   data-extra="${v.extra}">
                            <button type="button" class="btn-qty" onclick="changeQty(this, 1)">+</button>
                        </div>
                    </div>
                    <input type="text" class="option-note" placeholder="ğŸ‘¤ è«‹å¡«å¯«æ­¤é …ç›®çš„å§“åæˆ–åº§è™Ÿ">
                </div>
            `).join('');

            menuHtml += `
                <div class="menu-item">
                    <div class="dish-header">
                        <img src="${imgSrc}" class="dish-image">
                        <div class="dish-name">${dish.name}</div>
                    </div>
                    ${varHtml}
                </div>`;
        });
        menuDiv.innerHTML = menuHtml;
    }

    document.getElementById('orderForm').onsubmit = async (e) => {
        e.preventDefault();
        
        const phoneInput = document.getElementById('phone');
        const phoneValue = phoneInput.value.trim();
        const phoneRegex = /^09\d{8}$/;
        const className = document.getElementById('class').value;
        const buyerName = document.getElementById('name').value;

        if (!phoneValue) {
            alert("âŒ è«‹å¡«å¯«è¨‚è³¼äººè¯çµ¡é›»è©±ï¼");
            phoneInput.focus();
            return;
        }

        if (!phoneRegex.test(phoneValue)) {
            alert("âŒ é›»è©±æ ¼å¼éŒ¯èª¤ï¼\n\n1. å¿…é ˆæ˜¯ 09 é–‹é ­\n2. å¿…é ˆæ˜¯ 10 ç¢¼æ•¸å­—\n3. è«‹å‹¿åŒ…å« - æˆ–ç©ºæ ¼\n\nç¯„ä¾‹ï¼š0912345678");
            phoneInput.focus();
            return;
        }

        const finalItems = [];
        let totalAmount = 0;

        try {
            document.querySelectorAll('.qty-input').forEach(input => {
                const qty = parseInt(input.value);
                if (qty > 0) {
                    const noteInput = input.closest('.option-item').querySelector('.option-note');
                    const noteValue = noteInput.value.trim();
                    
                    if (!noteValue) {
                        alert(`âŒ è«‹å¡«å¯«ã€Œ${input.dataset.dishName} - ${input.dataset.variation}ã€çš„è¨‚è³¼äººå§“åï¼`);
                        noteInput.focus();
                        throw new Error("Missing Note");
                    }

                    const price = parseInt(input.dataset.basePrice) + parseInt(input.dataset.extra);
                    finalItems.push({
                        name: `${input.dataset.dishName} (${input.dataset.variation})`,
                        qty: qty,
                        price: price,
                        note: noteValue,
                        subtotal: qty * price
                    });
                    totalAmount += qty * price;
                }
            });
        } catch(err) { return; } 

        if (finalItems.length === 0) return alert("âŒ æœªé¸æ“‡ä»»ä½•é¤é»");

        const btn = document.getElementById('submit-btn');
        btn.disabled = true; btn.innerText = "è³‡æ–™ä¸Šå‚³èˆ‡è£½åœ–ä¸­...";

        try {
            // 1. ä¸Šå‚³ Firebase
            await addDoc(collection(db, "orders"), {
                class: className,
                name: buyerName,
                phone: phoneValue,
                order_items: finalItems,
                total_amount: totalAmount,
                order_time: serverTimestamp(),
                paid: false
            });

            // 2. æº–å‚™åœ–ç‰‡
            const now = new Date();
            const timeStr = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes()}`;
            
            document.getElementById('receipt-info').innerHTML = 
                `æ™‚é–“ï¼š${timeStr}<br>ç­ç´šï¼š${className}<br>å§“åï¼š${buyerName}<br>é›»è©±ï¼š${phoneValue}`;
            
            let itemsHtml = "";
            finalItems.forEach(item => {
                itemsHtml += `
                    <tr>
                        <td>${item.name}<br><small style='color:#666'>(${item.note})</small></td>
                        <td>${item.qty}</td>
                        <td>$${item.subtotal}</td>
                    </tr>`;
            });
            document.getElementById('receipt-items').innerHTML = itemsHtml;
            document.getElementById('receipt-total').innerText = `ç¸½è¨ˆ $${totalAmount}`;

            // 3. è½‰åœ–ç‰‡ä¸‹è¼‰
            const receiptEl = document.getElementById('receipt-container');
            await new Promise(r => setTimeout(r, 200));

            const canvas = await html2canvas(receiptEl, {
                scale: 2, 
                backgroundColor: "#ffffff"
            });

            const link = document.createElement('a');
            link.download = `è¨‚å–®æ˜ç´°_${timeStr.replace(/[\/\s:]/g, '')}.jpg`;
            link.href = canvas.toDataURL("image/jpeg");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            alert("âœ… è¨‚å–®æˆåŠŸï¼åœ–ç‰‡å·²ä¸‹è¼‰ï¼Œè«‹ç¢ºèªã€‚");
            location.reload();

        } catch (e) { 
            console.error(e);
            alert("âš ï¸ è¨‚å–®å¯èƒ½å·²é€å‡ºï¼Œä½†åœ–ç‰‡ç”¢ç”Ÿå¤±æ•—ã€‚\néŒ¯èª¤ï¼š" + e.message); 
            btn.disabled = false; 
            btn.innerText = "ç¢ºèªé€å‡ºè¨‚å–®";
        }
    };
</script>
</body>
</html>